# Pi5 Sensor Hub

This project upgrades the old "devices -> Google Apps Script" flow to:

- Pico W + ESP32-C6 (MicroPython) send telemetry to Pi 5 over Wi-Fi
- Pi 5 ingests into PostgreSQL
- Pi 5 sends Slack alerts and hourly summaries
- Pi 5 appends hourly rows to Google Sheets (optional)

## Architecture

```text
Pico W (MicroPython)   \
                        >  Pi5 FastAPI (/ingest) -> PostgreSQL
ESP32-C6 + BME680      /            |              \
                                   |               -> Google Sheets (hourly, optional)
                                   -> Slack alerts/reports
```

## Repository Layout

```text
src/pi5_hub/
  main.py           # API and startup lifecycle
  scheduler.py      # minute monitor + hourly report jobs
  repository.py     # PostgreSQL access
  alerts.py         # stale-data + HVAC alert logic
  reports.py        # hourly aggregation + dispatch
  slack_client.py   # Slack webhook sender
  sheets_client.py  # Google Sheets appender

sql/init.sql        # DB schema
scripts/init_db.py  # DB bootstrap helper
scripts/flash.py    # .env-driven board flashing helper

firmware/pico_w/main.py
firmware/esp32_c6/main.py
```

## Prerequisites

- Python 3.11+
- `uv`
- PostgreSQL 15+
- MicroPython boards connected over USB when flashing
- Optional: `mpremote` (recommended) or `rshell`

## Setup (uv-only)

```bash
uv venv
source .venv/bin/activate
uv sync
cp .env.example .env
```

Fill `.env` values:

- `DATABASE_URL`
- `REQUIRED_DEVICES` (example: `pico_w_1,esp32_c6_1`)
- `SLACK_WEBHOOK_URL` (optional but recommended)
- `GOOGLE_SERVICE_ACCOUNT_JSON` + `GOOGLE_SHEETS_SPREADSHEET_ID` (optional)
- `API_KEY` (optional; if set, devices must send `X-API-Key`)

### Secret Hygiene

- `.env` contains real credentials—**never commit it** (it's gitignored)
- Keep `.env.example` placeholders only (no real values)
- Board `config.py` generated by `scripts/flash.py` may contain Wi-Fi/API secrets—keep it local, do not commit
- If secrets are accidentally exposed, rotate affected webhooks/API keys immediately

## Initialize Database

```bash
uv run python scripts/init_db.py
```

Connection-only check:

```bash
uv run python scripts/init_db.py --check-only
```

## Run Pi5 Service

Run API (scheduler runs in-process on startup):

```bash
uv run uvicorn pi5_hub.main:app --host 0.0.0.0 --port 8000
```

You should not run `pi5_hub.scheduler` at the same time as the API process unless you intentionally want a separate scheduler process.

Health check:

```bash
curl http://localhost:8000/health
```

## Alerts and Reports

The Pi5 jobs preserve the previous Apps Script behavior:

- stale-data alert when no new reading for `INACTIVITY_MINUTES` (default `5`)
- stale alert requires `STALE_CONSECUTIVE_MISSES` (default `4`) consecutive checks before alerting to reduce false positives
- stale alert cooldown via `ALERT_COOLDOWN_MINUTES` (default `30`)
- recovery alert when data resumes
- HVAC alert when ESP32 temperature crosses `HVAC_TEMP_THRESHOLD` (default `25.0`)
- HVAC alert cooldown via `HVAC_ALERT_COOLDOWN_MINUTES` (default `30`)
- hourly summary to Slack and Google Sheets (via Apps Script or direct API)

## Firmware

Firmware lives in:

- `firmware/pico_w/main.py`
- `firmware/esp32_c6/main.py`

Both files:

- try to load `config.py` uploaded by `scripts/flash.py`
- fall back to inline defaults if `config.py` is missing
- send payload fields like `device_id`, `device_ts`, `firmware`, `request_id`

## Flashing Boards from .env

Install one flashing backend:

```bash
uv tool install mpremote
# or
uv tool install rshell
```

Flash Pico W:

```bash
uv run python scripts/flash.py --target pico_w
```

Flash ESP32-C6:

```bash
uv run python scripts/flash.py --target esp32_c6
```

Useful flags:

```bash
uv run python scripts/flash.py --target pico_w --dry-run
uv run python scripts/flash.py --target pico_w --verify
uv run python scripts/flash.py --target pico_w --port /dev/ttyACM0
uv run python scripts/flash.py --target esp32_c6 --backend rshell
```

`scripts/flash.py` uploads:

- generated `config.py` from `.env` (contains credentials—do not commit)
- target firmware `firmware/<target>/main.py` as board `main.py`

## API

### `POST /ingest`

- Accepts Pico and ESP32 payloads
- Dedupes by `(device_id, request_id)` when `request_id` is present
- Enforces `X-API-Key` only if `API_KEY` is configured

Example:

```bash
curl -X POST http://localhost:8000/ingest \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your_api_key" \
  -d '{"device_id":"pico_w_1","request_id":"abc-1","temperature":24.1}'
```

### `GET /devices`

Lists devices with readings since UTC midnight.

## Migration Note (from Google Apps Script)

Old:

```text
Pico/ESP32 -> Google Apps Script -> Google Sheets + Slack
```

New:

```text
Pico/ESP32 -> Pi5 (/ingest) -> PostgreSQL -> Slack + Google Sheets (hourly)
```

Keep `google_apps_script.js` in this repo as a behavior reference while validating parity.

## Google Sheets Delivery Modes

Hourly reports can be delivered to Google Sheets in two ways:

### Apps Script Webapp (recommended)

Set `APPS_SCRIPT_WEBAPP_URL` to a deployed Google Apps Script webapp URL. The Pi5 hub POSTs JSON payloads to the webapp's `doPost` handler, which appends rows to the sheet. This avoids service account credential management.

```bash
APPS_SCRIPT_WEBAPP_URL=https://script.google.com/macros/s/your-script-id/exec
```

Payload fields sent:
- `device_id`, `device_ts` (ISO), `firmware='pi5_hub_hourly'`, `request_id` (deterministic per device+hour)
- For pico-like device IDs: `raw_adc=None`, `voltage=None`, `temperature`
- For other devices: `temperature`, `humidity`, `pressure`, `gas`
- Counters: `stink_count`, `total_stink_count`, `success_count`, `total_success_count`, `total_requests`, `uptime_cycles`, `reset_count=0`

### Direct Sheets API (fallback)

If `APPS_SCRIPT_WEBAPP_URL` is not set but `GOOGLE_SERVICE_ACCOUNT_JSON` and `GOOGLE_SHEETS_SPREADSHEET_ID` are configured, the hub uses the service account to append rows directly via the Google Sheets API.

## Troubleshooting

- No device data: check `/health`, then inspect Pi5 logs and `DATABASE_URL`
- Auth failures: verify `API_KEY` in `.env` matches flashed config
- Flash issues: pass explicit `--port` and run `--verify`
- Google Sheets failures: verify service account file path and sheet sharing permissions
