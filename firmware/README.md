# Firmware for MicroPython Telemetry Clients

This directory contains MicroPython firmware for telemetry devices that send sensor data to a Raspberry Pi 5 ingest endpoint.

The recommended deployment flow is `scripts/flash.py`, which uploads `main.py` and a generated `config.py` with Wi-Fi and Pi5 endpoint settings.

> **Warning:** Generated `config.py` contains credentials (Wi-Fi password, API keys). Keep it local to each board—never commit to version control.

## Directory Structure

```
firmware/
├── README.md           # This file
├── pico_w/
│   └── main.py         # Raspberry Pi Pico W firmware
└── esp32_c6/
    └── main.py         # ESP32-C6 firmware (BME680 sensor)
```

---

## Raspberry Pi Pico W

### Features
- Internal temperature sensor
- ADC reading on GPIO26 (ADC0)
- Wi-Fi telemetry to Pi5
- Dual LED status indication:
  - onboard green LED for link/activity
  - external red LED on GP5 for errors

### Wiring

| Component | Pico W Pin |
|-----------|------------|
| ADC Input | GP26 (Pin 31) - ADC0 |
| Red LED anode (via resistor) | GP5 (Pin 7) |
| Red LED cathode | GND |

The internal temperature sensor uses ADC4 (no wiring required).

### LED Indication Behavior

- Green solid ON: Wi-Fi connected
- Green short blink: telemetry send success
- Red double blink: telemetry send failure
- Green OFF: Wi-Fi disconnected

### Required Libraries
- None (uses built-in MicroPython modules only)

### Upload to Pico W

1. Install [MicroPython](https://micropython.org/download/rp2-pico-w/) on Pico W
2. Use `mpremote` to upload:

```bash
# Using mpremote from repo root
mpremote connect /dev/ttyACM0 cp firmware/pico_w/main.py :main.py
```

3. Preferred: upload `config.py` generated by `scripts/flash.py` (contains credentials—do not commit).

Fallback: edit defaults at top of `main.py`.

### Configuration Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `WIFI_SSID` | `YOUR_WIFI_SSID` | Wi-Fi network name |
| `WIFI_PASSWORD` | `YOUR_WIFI_PASSWORD` | Wi-Fi password |
| `PI5_HOST` | `192.168.1.100` | Pi5 IP address |
| `PI5_PORT` | `8000` | Pi5 server port |
| `INGEST_ENDPOINT` | `/ingest` | API endpoint |
| `DEVICE_ID` | `pico_w_01` | Unique device identifier |
| `FIRMWARE_VERSION` | `1.0.0` | Firmware version |
| `SEND_INTERVAL_SEC` | `60` | Seconds between readings |

### Telemetry Payload

```json
{
  "device_id": "pico_w_01",
  "device_ts": 1700000000,
  "firmware": "1.0.0",
  "request_id": "pico_w_01-1700000000-1-1234",
  "raw_adc": 32768,
  "voltage": 1.65,
  "temperature": 25.5
}
```

---

## ESP32-C6 with BME680

### Features
- BME680 environmental sensor (temperature, humidity, pressure, gas)
- Graceful sensor failure handling with retry
- Single onboard LED status indicator
- Wi-Fi telemetry to Pi5

### Wiring

| BME680 Pin | ESP32-C6 Pin | GPIO |
|------------|--------------|------|
| VCC | 3.3V | - |
| GND | GND | - |
| SCL | GPIO20 | 20 |
| SDA | GPIO19 | 19 |

I2C pins are configurable via `config.py` using `BME680_SDA_PIN` and `BME680_SCL_PIN`.

### LED Indication Behavior (Single LED on IO15 / D13)

The ESP32-C6 uses a single status LED on GPIO15 (D13) for all status indication:

| LED Pattern | Meaning |
|-------------|---------|
| LED ON steady | Wi-Fi connected and idle |
| LED OFF | Wi-Fi disconnected |
| Single short blink → steady ON | Telemetry send success |
| Double blink → steady state | Telemetry send failure / retry exhausted |
| Triple quick blink → steady state | Unexpected main loop exception |

The LED automatically reflects Wi-Fi connection state and returns to steady state after any notification pattern.

### Required Libraries

Upload the BME680 library to the ESP32-C6:

```bash
# Download from MicroPython libraries or use mpremote
mpremote connect /dev/ttyUSB0 cp bme680.py :bme680.py
```

**Note:** The `bme680.py` library is required. If not found, the firmware will:
1. Print a clear error message to serial
2. Continue running with `sensor_error` field in payload
3. Retry sensor initialization periodically

### Upload to ESP32-C6

1. Install [MicroPython](https://micropython.org/download/ESP32_GENERIC_C6/) on ESP32-C6
2. Upload the BME680 library first
3. Upload main.py:

```bash
# Using mpremote
mpremote connect /dev/ttyUSB0 cp bme680.py :bme680.py
mpremote connect /dev/ttyUSB0 cp firmware/esp32_c6/main.py :main.py
```

4. Preferred: upload `config.py` generated by `scripts/flash.py` (contains credentials—do not commit).

Fallback: edit defaults at top of `main.py`.

### Configuration Variables

Same as Pico W, plus:
- Default `DEVICE_ID`: `esp32_c6_01`

### Telemetry Payload

```json
{
  "device_id": "esp32_c6_01",
  "device_ts": 1700000000,
  "firmware": "1.0.0",
  "request_id": "esp32_c6_01-1700000000-1-1234",
  "temperature": 25.5,
  "humidity": 45.2,
  "pressure": 1013.25,
  "gas": 150000
}
```

When sensor is unavailable:
```json
{
  "device_id": "esp32_c6_01",
  "device_ts": 1700000000,
  "firmware": "1.0.0",
  "request_id": "esp32_c6_01-1700000000-1-1234",
  "sensor_error": "BME680 unavailable"
}
```

---

## Common Features

### Retry & Backoff Behavior

Both clients implement:
- **Wi-Fi reconnection**: Exponential backoff (2s → 4s → 8s → 16s → 30s max)
- **HTTP retries**: 3 attempts with backoff (1s → 2s → 4s)
- **Connection monitoring**: Automatic reconnection on connection loss
- **Failure recovery**: WiFi reset after 10 consecutive failures

### Request ID Format

```
{device_id}-{timestamp}-{counter}-{random}
```

Example: `pico_w_01-1700000000-42-5678`

### Serial Monitoring

Connect via USB serial (115200 baud) to see:
- Wi-Fi connection status
- Sensor readings
- HTTP request/response status
- Error messages

```bash
# Using mpremote
mpremote connect /dev/ttyACM0

# Or screen/minicom
screen /dev/ttyACM0 115200
```

---

## Troubleshooting

### Pico W

| Issue | Solution |
|-------|----------|
| Wi-Fi won't connect | Check SSID/password, verify network is 2.4GHz |
| Temperature seems wrong | Internal sensor is approximate, affected by CPU heat |
| ADC noise | Add capacitor, use averaging if needed |

### ESP32-C6

| Issue | Solution |
|-------|----------|
| "bme680 library not found" | Upload `bme680.py` to device |
| "BME680 not detected" | Check I2C wiring (SDA=GPIO20, SCL=GPIO19 by default) |
| I2C scan shows no devices | Check power, pull-up resistors, wiring |
| Gas readings unstable | BME680 gas sensor needs burn-in period |

---

## Pi5 Server Requirements

The Pi5 should run an HTTP server accepting POST requests at `/ingest`:

```python
# Minimal Flask example
from flask import Flask, request

app = Flask(__name__)

@app.route('/ingest', methods=['POST'])
def ingest():
    data = request.json
    print(f"Received from {data.get('device_id')}: {data}")
    return {'status': 'ok'}, 200

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000)
```
